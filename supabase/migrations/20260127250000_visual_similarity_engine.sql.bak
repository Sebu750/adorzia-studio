-- FR 1: Visual Similarity Engine (Vibe-Match)
-- TEMPORARILY DISABLED: Requires pgvector extension with elevated permissions
-- CREATE EXTENSION IF NOT EXISTS vector;

-- System for product recommendations based on visual silhouettes and fabric textures

-- Product Visual Attributes Table
CREATE TABLE IF NOT EXISTS public.product_visual_attributes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.marketplace_products(id) ON DELETE CASCADE UNIQUE,
  
  -- Visual Silhouette Attributes
  silhouette_type TEXT[] DEFAULT '{}', -- 'fitted', 'oversized', 'flowy', 'structured', 'draped'
  garment_length TEXT, -- 'mini', 'midi', 'maxi', 'knee-length', 'ankle-length'
  neckline_style TEXT[], -- 'v-neck', 'crew', 'off-shoulder', 'high-neck', 'square'
  sleeve_style TEXT[], -- 'sleeveless', 'short', 'long', '3/4', 'bell', 'puff'
  
  -- Fabric & Texture Attributes
  fabric_weight TEXT, -- 'lightweight', 'medium', 'heavy'
  fabric_texture TEXT[], -- 'smooth', 'textured', 'embroidered', 'printed', 'woven'
  fabric_finish TEXT[], -- 'matte', 'glossy', 'metallic', 'sheer', 'opaque'
  dominant_material TEXT, -- 'cotton', 'silk', 'chiffon', 'velvet', 'linen', 'wool'
  
  -- Color Analysis
  primary_colors TEXT[] DEFAULT '{}', -- Hex codes
  color_palette TEXT, -- 'monochrome', 'neutral', 'bold', 'pastel', 'earth-tones'
  color_saturation TEXT, -- 'vibrant', 'muted', 'mixed'
  
  -- Pattern & Embellishment
  pattern_type TEXT[], -- 'solid', 'floral', 'geometric', 'abstract', 'striped', 'polka-dot'
  embellishment_level TEXT, -- 'minimal', 'moderate', 'heavy'
  embellishment_types TEXT[], -- 'embroidery', 'beading', 'sequins', 'lace', 'applique'
  
  -- Style Aesthetic Tags
  aesthetic_tags TEXT[] DEFAULT '{}', -- 'minimalist', 'avant-garde', 'traditional', 'contemporary', 'romantic', 'edgy'
  occasion_fit TEXT[], -- 'casual', 'formal', 'cocktail', 'bridal', 'festive'
  
  -- Visual Similarity Vector (for ML-based matching)
  visual_embedding VECTOR(512), -- Image embedding from vision model
  
  -- Metadata
  confidence_score DECIMAL(3,2) DEFAULT 0.0, -- AI extraction confidence
  manually_verified BOOLEAN DEFAULT false,
  verified_by UUID REFERENCES auth.users(id),
  verified_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Product Similarity Matches (Pre-computed)
CREATE TABLE IF NOT EXISTS public.product_similarity_matches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID NOT NULL REFERENCES public.marketplace_products(id) ON DELETE CASCADE,
  similar_product_id UUID NOT NULL REFERENCES public.marketplace_products(id) ON DELETE CASCADE,
  similarity_score DECIMAL(4,3) NOT NULL, -- 0.000 to 1.000
  match_reason TEXT[], -- 'silhouette', 'color', 'texture', 'pattern', 'aesthetic'
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(product_id, similar_product_id),
  CHECK (product_id != similar_product_id)
);

-- User Visual Preferences (Vibe Profile)
CREATE TABLE IF NOT EXISTS public.user_visual_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  
  -- Learned Preferences from Browsing/Purchases
  preferred_silhouettes TEXT[] DEFAULT '{}',
  preferred_fabrics TEXT[] DEFAULT '{}',
  preferred_colors TEXT[] DEFAULT '{}',
  preferred_aesthetics TEXT[] DEFAULT '{}',
  
  -- Preference Scores
  preference_vector JSONB DEFAULT '{}'::jsonb, -- Weighted attribute preferences
  
  -- Anti-preferences (things user avoids)
  avoided_attributes TEXT[] DEFAULT '{}',
  
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- User Interaction Events (for learning)
CREATE TABLE IF NOT EXISTS public.user_product_interactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  session_id TEXT, -- For anonymous users
  product_id UUID NOT NULL REFERENCES public.marketplace_products(id) ON DELETE CASCADE,
  interaction_type TEXT NOT NULL, -- 'view', 'like', 'cart_add', 'purchase', 'wishlist'
  duration_seconds INTEGER, -- Time spent viewing
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Enable RLS
ALTER TABLE public.product_visual_attributes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.product_similarity_matches ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_visual_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_product_interactions ENABLE ROW LEVEL SECURITY;

-- RLS Policies: Visual Attributes
CREATE POLICY "Public can view visual attributes"
  ON public.product_visual_attributes FOR SELECT
  USING (true);

CREATE POLICY "Admins can manage visual attributes"
  ON public.product_visual_attributes FOR ALL
  TO authenticated
  USING (
    public.has_role(auth.uid(), 'admin') OR public.has_role(auth.uid(), 'superadmin')
  );

-- RLS Policies: Similarity Matches
CREATE POLICY "Public can view similarity matches"
  ON public.product_similarity_matches FOR SELECT
  USING (true);

-- RLS Policies: User Preferences
CREATE POLICY "Users can view own preferences"
  ON public.user_visual_preferences FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

CREATE POLICY "Users can manage own preferences"
  ON public.user_visual_preferences FOR ALL
  TO authenticated
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

-- RLS Policies: Interactions
CREATE POLICY "Users can view own interactions"
  ON public.user_product_interactions FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

CREATE POLICY "Users can log product interactions"
  ON public.user_product_interactions FOR INSERT
  WITH CHECK (
    -- Must have either authenticated user_id or anonymous session_id
    (user_id IS NOT NULL AND user_id = auth.uid()) 
    OR (user_id IS NULL AND session_id IS NOT NULL AND LENGTH(session_id) > 0)
    -- Validate required fields
    AND product_id IS NOT NULL
    AND interaction_type IS NOT NULL
    AND interaction_type IN ('view', 'like', 'cart_add', 'purchase', 'wishlist')
    -- Validate duration if provided
    AND (duration_seconds IS NULL OR duration_seconds > 0)
  );

-- Function: Find Similar Products
CREATE OR REPLACE FUNCTION find_similar_products(
  p_product_id UUID,
  p_limit INTEGER DEFAULT 10
)
RETURNS TABLE (
  product_id UUID,
  similarity_score DECIMAL,
  match_reasons TEXT[]
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    psm.similar_product_id,
    psm.similarity_score,
    psm.match_reason
  FROM public.product_similarity_matches psm
  JOIN public.marketplace_products mp ON mp.id = psm.similar_product_id
  WHERE psm.product_id = p_product_id
    AND mp.status = 'live'
  ORDER BY psm.similarity_score DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;

-- Function: Get Personalized Recommendations
CREATE OR REPLACE FUNCTION get_personalized_recommendations(
  p_user_id UUID,
  p_limit INTEGER DEFAULT 20
)
RETURNS TABLE (
  product_id UUID,
  relevance_score DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  WITH user_prefs AS (
    SELECT 
      preferred_silhouettes,
      preferred_fabrics,
      preferred_aesthetics
    FROM public.user_visual_preferences
    WHERE user_id = p_user_id
  ),
  recent_interactions AS (
    SELECT DISTINCT product_id
    FROM public.user_product_interactions
    WHERE user_id = p_user_id
    ORDER BY created_at DESC
    LIMIT 10
  )
  SELECT 
    mp.id AS product_id,
    (
      -- Calculate relevance based on attribute overlap
      CASE 
        WHEN pva.silhouette_type && (SELECT preferred_silhouettes FROM user_prefs) THEN 0.3
        ELSE 0.0
      END +
      CASE 
        WHEN pva.dominant_material = ANY((SELECT preferred_fabrics FROM user_prefs)) THEN 0.3
        ELSE 0.0
      END +
      CASE 
        WHEN pva.aesthetic_tags && (SELECT preferred_aesthetics FROM user_prefs) THEN 0.4
        ELSE 0.0
      END
    )::DECIMAL AS relevance_score
  FROM public.marketplace_products mp
  JOIN public.product_visual_attributes pva ON pva.product_id = mp.id
  WHERE mp.status = 'live'
    AND mp.id NOT IN (SELECT product_id FROM recent_interactions)
  HAVING relevance_score > 0.3
  ORDER BY relevance_score DESC
  LIMIT p_limit;
END;
$$ LANGUAGE plpgsql;

-- Function: Update User Preferences from Interactions
CREATE OR REPLACE FUNCTION update_user_visual_preferences(p_user_id UUID)
RETURNS VOID AS $$
DECLARE
  v_preferred_silhouettes TEXT[];
  v_preferred_fabrics TEXT[];
  v_preferred_aesthetics TEXT[];
BEGIN
  -- Aggregate preferences from purchased/liked products
  SELECT 
    ARRAY_AGG(DISTINCT unnest_val ORDER BY unnest_val) FILTER (WHERE unnest_val IS NOT NULL),
    ARRAY_AGG(DISTINCT pva.dominant_material) FILTER (WHERE pva.dominant_material IS NOT NULL),
    ARRAY_AGG(DISTINCT unnest_aesthetic ORDER BY unnest_aesthetic) FILTER (WHERE unnest_aesthetic IS NOT NULL)
  INTO 
    v_preferred_silhouettes,
    v_preferred_fabrics,
    v_preferred_aesthetics
  FROM public.user_product_interactions upi
  JOIN public.product_visual_attributes pva ON pva.product_id = upi.product_id
  CROSS JOIN LATERAL unnest(pva.silhouette_type) AS unnest_val
  CROSS JOIN LATERAL unnest(pva.aesthetic_tags) AS unnest_aesthetic
  WHERE upi.user_id = p_user_id
    AND upi.interaction_type IN ('purchase', 'like', 'wishlist')
    AND upi.created_at > NOW() - INTERVAL '6 months';

  -- Upsert preferences
  INSERT INTO public.user_visual_preferences (
    user_id,
    preferred_silhouettes,
    preferred_fabrics,
    preferred_aesthetics
  )
  VALUES (
    p_user_id,
    v_preferred_silhouettes,
    v_preferred_fabrics,
    v_preferred_aesthetics
  )
  ON CONFLICT (user_id) DO UPDATE SET
    preferred_silhouettes = EXCLUDED.preferred_silhouettes,
    preferred_fabrics = EXCLUDED.preferred_fabrics,
    preferred_aesthetics = EXCLUDED.preferred_aesthetics,
    updated_at = NOW();
END;
$$ LANGUAGE plpgsql;

-- Indexes for Performance
CREATE INDEX IF NOT EXISTS idx_visual_attrs_product ON public.product_visual_attributes(product_id);
CREATE INDEX IF NOT EXISTS idx_visual_attrs_silhouette ON public.product_visual_attributes USING GIN(silhouette_type);
CREATE INDEX IF NOT EXISTS idx_visual_attrs_aesthetics ON public.product_visual_attributes USING GIN(aesthetic_tags);
CREATE INDEX IF NOT EXISTS idx_similarity_product ON public.product_similarity_matches(product_id);
CREATE INDEX IF NOT EXISTS idx_similarity_score ON public.product_similarity_matches(similarity_score DESC);
CREATE INDEX IF NOT EXISTS idx_interactions_user ON public.user_product_interactions(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_interactions_product ON public.user_product_interactions(product_id);

-- Trigger: Update timestamp
CREATE TRIGGER update_visual_attributes_timestamp
  BEFORE UPDATE ON public.product_visual_attributes
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

COMMENT ON TABLE public.product_visual_attributes IS 'FR 1: Visual attributes for Vibe-Match similarity engine';
COMMENT ON TABLE public.product_similarity_matches IS 'FR 1: Pre-computed product similarity matches';
COMMENT ON TABLE public.user_visual_preferences IS 'FR 1: User visual preference profiles for personalization';
